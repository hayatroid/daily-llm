---
import BaseLayout from '../layouts/BaseLayout.astro';
import ConversationPreviewCard from '../components/ConversationPreviewCard.astro';
import DetailedSummaryCard from '../components/DetailedSummaryCard.astro';
import SimpleNav from '../components/SimpleNav.astro';
import CompactHeader from '../components/CompactHeader.astro';
import { ICONS, LABELS } from '../utils/icons.js';

export async function getStaticPaths() {
  // Get all content directories
  const summaries = await Astro.glob('../../content/**/summary.md');
  
  return summaries.map((summary) => ({
    params: { date: summary.frontmatter.date.toString() }
  }));
}

const { date } = Astro.params;

// Get all content files and filter for this date
const allContent = await Astro.glob('../../content/**/*.md');

// Get the summary for this date
const summary = allContent.filter(file => 
  file.file.includes(`/${date}/summary.md`)
);

// Get all conversations for this date
const conversations = allContent.filter(file => 
  file.file.includes(`/${date}/`) && !file.file.endsWith('summary.md')
);

// Sort conversations by filename
const sortedConversations = conversations
  .sort((a, b) => {
    const aNum = parseInt(a.file.split('/').pop()?.split('-')[0] || '0');
    const bNum = parseInt(b.file.split('/').pop()?.split('-')[0] || '0');
    return aNum - bNum;
  });


const pageTitle = `${date} - Daily LLM Conversations`;
---

<BaseLayout title={pageTitle}>
  <div class="main-content">
    <SimpleNav 
      currentDate={date}
      currentPage="date"
      allContent={allContent}
    />

    <CompactHeader 
      title={date}
      subtitle={LABELS.DAILY_CONVERSATIONS}
      icon={ICONS.CALENDAR}
      variant="page"
    />

    {summary.length > 0 && (
      <div class="summary-section">
        <CompactHeader 
          title="Daily Summary"
          icon={ICONS.SUMMARY}
          level={2}
          variant="section"
        />
        <DetailedSummaryCard summary={summary[0]} allContent={allContent} />
      </div>
    )}

    <div class="conversations-section">
      <CompactHeader 
        title={`Conversations (${sortedConversations.length})`}
        icon={ICONS.CONVERSATION}
        level={2}
        variant="section"
      />
      <div class="conversations-grid">
        {sortedConversations.map((conversation) => (
          <ConversationPreviewCard conversation={conversation} date={date} />
        ))}
      </div>
    </div>

    {sortedConversations.length === 0 && summary.length === 0 && (
      <div class="empty">
        <p class="comment"># {LABELS.NO_CONTENT_FOUND} {date}</p>
        <p>{LABELS.START_BY_ADDING} <code>content/{date}/</code></p>
      </div>
    )}
  </div>
</BaseLayout>


<style>
  
  /* CompactHeader コンポーネントで統一 */
  
  .summary-section {
    margin-bottom: var(--space-2xl);
  }
  
  .conversations-section {
    margin-bottom: 2rem;
  }
  
  .conversations-grid {
    display: grid;
    gap: 2rem;
    grid-template-columns: 1fr;
    margin-top: 2rem;
    width: 100%;
    grid-auto-rows: auto;
  }
  
  @media (min-width: 768px) {
    .conversations-grid {
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 2rem;
      align-items: start;
    }
  }
  
  @media (min-width: 1200px) {
    .conversations-grid {
      grid-template-columns: repeat(2, 1fr);
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }
  }
  
  .empty {
    text-align: center;
    padding: 3rem 2rem;
    border: 1px dashed var(--term-gray);
    border-radius: 4px;
    margin: 2rem 0;
  }
  
  .empty code {
    background: rgba(0, 255, 255, 0.1);
    color: var(--term-cyan);
    padding: 0.2em 0.4em;
    border-radius: 3px;
  }

  /* Responsive design */
  @media (max-width: 767px) {
    .conversations-grid {
      gap: var(--space-lg);
    }
  }
</style>